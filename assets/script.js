const i18n = {
  de: {
    'nav.menu': 'Menü',
    'nav.menuAria': 'Navigation öffnen oder schließen',
    'nav.aria': 'Hauptnavigation',
    'nav.start': 'Start',
    'nav.about': 'Über mich',
    'nav.philosophy': 'Philosophie',
    'nav.contact': 'Kontakt',
    'lang.aria': 'Sprachauswahl',
    'hero.eyebrow': 'Klarweg Beratung',
    'hero.title': 'Du musst nicht im Dunkeln bleiben – es gibt einen Weg zurück ins Leben.',
    'hero.subtitle': 'Ich begleite dich mit Ruhe, Struktur und einer klaren Strategie aus der Abhängigkeit – professionell, vertraulich und immer an deiner Seite.',
    'hero.primaryCta': 'Kontakt aufnehmen',
    'hero.secondaryCta': 'Über WhatsApp melden',
    'ctaBand.text': 'Bereit für den ersten Schritt? Schreibe mir direkt über WhatsApp: +49 172 7215187',
    'ctaBand.button': 'Jetzt über WhatsApp schreiben',
    'about.eyebrow': 'Sigrid Wadenpohl',
    'about.heading': 'Über mich',
    'about.intro': 'Ich bin Sigrid Wadenpohl – Suchtberaterin (i.A.) und Heilpraktikerin. Ich begleite Menschen und Angehörige mit Klarheit, Respekt und einem individuellen, alltagstauglichen Ansatz.',
    'about.cvHeading': 'Lebenslauf',
    'about.cv1': '13.02.1960 geboren in Düsseldorf',
    'about.cv2': '1979 Abschluss Abitur (Lise-Meitner-/Humboldt-Gymnasium)',
    'about.cv3': '1980 Ausbildung zur Medizinisch-Technischen Laborassistentin (Uni Düsseldorf)',
    'about.cv4': 'Umfangreiche Tätigkeit in Forschung (Henkel) sowie in Praxen: Kardiologie, Gynäkologie, Allergologie',
    'about.cv5': '2008 Ausbildung zur Heilpraktikerin (Paracelsus Schule Düsseldorf)',
    'about.cv6': 'Zusatzausbildungen: Homöopathie, Akupunktur, Ernährungsberatung',
    'about.cv7': '2025 Ausbildung zur Suchtberaterin (Paracelsus Schule)',
    'about.detail1': 'Ich verbinde fundierte medizinische Praxis mit naturheilkundlichen Methoden und einem offenen Blick für Spiritualität.',
    'about.detail2': 'Das Ergebnis ist ein realitätsnahes Vorgehen: Schritt für Schritt, abgestimmt auf deine Ressourcen und auf das, was dein Alltag zulässt.',
    'philosophy.eyebrow': 'Ansatz',
    'philosophy.heading': 'Philosophie',
    'philosophy.p1': 'Jede Geschichte ist einzigartig, doch die Mechanismen von Abhängigkeit ähneln sich. Ich erkenne die Unterschiede – und benutze dieses Wissen, um einen individuellen Plan zu entwickeln.',
    'philosophy.p2': 'Ich kombiniere strukturierte Beratung, Körperarbeit, spirituelle Impulse und meine lange Erfahrung aus medizinischen Einrichtungen. So entsteht ein geschützter Rahmen, in dem Veränderung möglich wird.',
    'philosophy.p3': 'Mit Klarheit, ehrlichem Feedback und machbaren Aufgaben begleite ich dich und deine Angehörigen – ohne Druck, aber mit konsequenter Ausrichtung auf Stabilität und Rückfallprävention.',
    'contact.eyebrow': 'Kontakt',
    'contact.heading': 'Kontakt',
    'contact.text': 'Schreibe mir vertraulich – ich melde mich zeitnah zurück.',
    'contact.safety': 'In akuten Notfällen wende dich bitte an den Notruf (112) oder den ärztlichen Bereitschaftsdienst (116117).',
    'contact.form.nameLabel': 'Name',
    'contact.form.namePlaceholder': 'Dein Name',
    'contact.form.emailLabel': 'E-Mail',
    'contact.form.emailPlaceholder': 'name@mail.de',
    'contact.form.topicLabel': 'Thema',
    'contact.form.topicPlaceholder': 'Bitte Thema wählen',
    'contact.form.topic1': 'Unterstützung für mich',
    'contact.form.topic2': 'Unterstützung für Angehörige',
    'contact.form.topic3': 'Ablauf & Termine',
    'contact.form.topic4': 'Andere Frage',
    'contact.form.messageLabel': 'Nachricht',
    'contact.form.messagePlaceholder': 'Deine Nachricht',
    'contact.form.submit': 'Nachricht senden',
    'contact.form.sending': 'Senden...',
    'contact.form.success': 'Danke! Deine Nachricht wurde notiert. Ich melde mich zeitnah.',
    'contact.form.errorRequired': 'Bitte fülle alle erforderlichen Felder aus.',
    'contact.form.errorEmail': 'Bitte gib eine gültige E-Mail-Adresse ein.',
    'contact.form.errorServer': 'Etwas ist schiefgelaufen. Bitte versuche es später erneut.',
    'contact.whatsappButton': 'Per WhatsApp schreiben',
    'contact.emailButton': 'Per E-Mail senden',
    'contact.emailSubject': 'Klarweg Anfrage',
    'contact.emailBodyIntro': 'Diese Nachricht wurde über das Formular auf klarweg.online erstellt.',
    'footer.disclaimer': 'Vertrauliche Beratung – ersetzt keine medizinische oder psychotherapeutische Notfallversorgung.'
  },
  en: {
    'nav.menu': 'Menu',
    'nav.menuAria': 'Toggle navigation',
    'nav.aria': 'Main navigation',
    'nav.start': 'Home',
    'nav.about': 'About me',
    'nav.philosophy': 'Philosophy',
    'nav.contact': 'Contact',
    'lang.aria': 'Language selection',
    'hero.eyebrow': 'Klarweg Counseling',
    'hero.title': 'You don’t have to stay in the dark—there is a way back to life.',
    'hero.subtitle': 'I guide you out of addiction with calm, structure, and a clear strategy—professional, discreet, and right by your side.',
    'hero.primaryCta': 'Get in touch',
    'hero.secondaryCta': 'Message on WhatsApp',
    'ctaBand.text': 'Ready for the first step? Message me directly on WhatsApp: +49 172 7215187',
    'ctaBand.button': 'Message via WhatsApp now',
    'about.eyebrow': 'Sigrid Wadenpohl',
    'about.heading': 'About me',
    'about.intro': 'I’m Sigrid Wadenpohl—addiction counselor (in training) and naturopathic practitioner. I support individuals and families with clarity, respect, and an approach that fits real life.',
    'about.cvHeading': 'CV',
    'about.cv1': 'Born 13 Feb 1960 in Düsseldorf',
    'about.cv2': '1979 High school diploma (Lise-Meitner / Humboldt Gymnasium)',
    'about.cv3': '1980 Training as Medical Laboratory Assistant (University of Düsseldorf)',
    'about.cv4': 'Extensive work in research (Henkel) and in medical practices: cardiology, gynecology, allergology',
    'about.cv5': '2008 Training as naturopathic practitioner (Paracelsus School Düsseldorf)',
    'about.cv6': 'Additional training: homeopathy, acupuncture, nutritional counseling',
    'about.cv7': '2025 Training as addiction counselor (Paracelsus School)',
    'about.detail1': 'I combine solid medical practice with naturopathic methods and an open perspective on spirituality.',
    'about.detail2': 'The result is a practical path: step by step, aligned with your resources and what everyday life allows.',
    'philosophy.eyebrow': 'Approach',
    'philosophy.heading': 'Philosophy',
    'philosophy.p1': 'Every story is different, yet the dynamics of addiction are alike. I honor the differences and use that insight to build a tailored plan.',
    'philosophy.p2': 'I bring together structured counseling, bodywork, spiritual impulses, and my long-standing experience in medical settings to create a safe space for change.',
    'philosophy.p3': 'With clarity, honest feedback, and doable steps I support you and your loved ones—without pressure, yet fully focused on stability and relapse prevention.',
    'contact.eyebrow': 'Contact',
    'contact.heading': 'Contact',
    'contact.text': 'Message me in confidence—I’ll get back to you soon.',
    'contact.safety': 'In emergencies, call the emergency number (112 in Germany) or the medical on-call service (116117).',
    'contact.form.nameLabel': 'Name',
    'contact.form.namePlaceholder': 'Your name',
    'contact.form.emailLabel': 'Email',
    'contact.form.emailPlaceholder': 'name@email.com',
    'contact.form.topicLabel': 'Topic',
    'contact.form.topicPlaceholder': 'Please choose a topic',
    'contact.form.topic1': 'Support for myself',
    'contact.form.topic2': 'Support for a loved one',
    'contact.form.topic3': 'Process & appointments',
    'contact.form.topic4': 'Other question',
    'contact.form.messageLabel': 'Message',
    'contact.form.messagePlaceholder': 'Your message',
    'contact.form.submit': 'Send message',
    'contact.form.sending': 'Sending...',
    'contact.form.success': 'Thank you! I have received your message and will reply shortly.',
    'contact.form.errorRequired': 'Please complete all required fields.',
    'contact.form.errorEmail': 'Please enter a valid email address.',
    'contact.form.errorServer': 'Something went wrong. Please try again later.',
    'contact.whatsappButton': 'Message via WhatsApp',
    'contact.emailButton': 'Send via email',
    'contact.emailSubject': 'Klarweg inquiry',
    'contact.emailBodyIntro': 'This message was created via the form on klarweg.online.',
    'footer.disclaimer': 'Confidential counseling—does not replace emergency medical or psychotherapeutic care.'
  }
};

const storageKey = 'klarweg_lang';
const htmlEl = document.documentElement;
const langButtons = document.querySelectorAll('.lang-btn');
const navToggle = document.querySelector('.nav-toggle');
const navLinks = document.querySelector('.nav-links');
const header = document.querySelector('.site-header');
const scrollLinks = document.querySelectorAll('[data-scroll]');
const form = document.getElementById('contact-form');
const formMessage = document.querySelector('.form-message');
const emailLink = document.getElementById('email-link');
const submitButton = form?.querySelector('button[type="submit"]') || null;
const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');
let currentLanguage = 'de';
let isSubmitting = false;
const emailPattern = /^[\w.!#$%&'*+/=?`{|}~-]+@[\w-]+(?:\.[\w-]+)+$/;

const translate = (key, lang = currentLanguage) => {
  return i18n[lang]?.[key] ?? i18n.de[key] ?? key;
};

function applyLanguage(lang) {
  if (!i18n[lang]) return;
  currentLanguage = lang;
  htmlEl.setAttribute('lang', lang);
  try {
    localStorage.setItem(storageKey, lang);
  } catch (err) {
    // Ignore storage errors (private mode, etc.)
  }

  document.querySelectorAll('[data-i18n]').forEach((el) => {
    const key = el.dataset.i18n;
    el.textContent = translate(key, lang);
  });

  document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
    const key = el.dataset.i18nPlaceholder;
    el.setAttribute('placeholder', translate(key, lang));
  });

  document.querySelectorAll('[data-i18n-aria-label]').forEach((el) => {
    const key = el.dataset.i18nAriaLabel;
    el.setAttribute('aria-label', translate(key, lang));
  });

  if (formMessage) {
    const messageKey = formMessage.dataset.messageKey || 'contact.form.success';
    if (messageKey !== 'custom') {
      formMessage.textContent = translate(messageKey, lang);
    }
  }

  langButtons.forEach((btn) => {
    btn.classList.toggle('active', btn.dataset.lang === lang);
  });

  if (submitButton) {
    const buttonKey = isSubmitting ? 'contact.form.sending' : 'contact.form.submit';
    submitButton.textContent = translate(buttonKey, lang);
  }
}

langButtons.forEach((button) => {
  button.addEventListener('click', () => {
    if (button.dataset.lang !== currentLanguage) {
      applyLanguage(button.dataset.lang);
    }
  });
});

function toggleNav() {
  if (!navLinks) return;
  const expanded = navLinks.classList.toggle('open');
  navToggle?.setAttribute('aria-expanded', expanded ? 'true' : 'false');
}

navToggle?.addEventListener('click', toggleNav);

function closeNav() {
  if (!navLinks) return;
  if (navLinks.classList.contains('open')) {
    navLinks.classList.remove('open');
    navToggle?.setAttribute('aria-expanded', 'false');
  }
}

function smoothScrollTo(targetId) {
  const target = document.querySelector(targetId);
  if (!target) return;
  const headerHeight = header?.offsetHeight ?? 0;
  const offsetTop = target.getBoundingClientRect().top + window.pageYOffset - headerHeight - 16;
  window.scrollTo({
    top: offsetTop,
    behavior: prefersReducedMotion.matches ? 'auto' : 'smooth'
  });
}

scrollLinks.forEach((link) => {
  link.addEventListener('click', (event) => {
    const href = link.getAttribute('href');
    if (href?.startsWith('#')) {
      event.preventDefault();
      smoothScrollTo(href);
      closeNav();
    }
  });
});

function setSubmitting(state) {
  if (!submitButton) return;
  isSubmitting = state;
  submitButton.disabled = state;
  const key = state ? 'contact.form.sending' : 'contact.form.submit';
  submitButton.textContent = translate(key);
}

const honeypotIdentifiers = ['hp_field', 'website'];

function isHoneypotField(element) {
  if (!element) return false;
  const id = (element.id || '').toLowerCase();
  const name = (element.name || '').toLowerCase();
  return honeypotIdentifiers.includes(id) || honeypotIdentifiers.includes(name);
}

function getRequiredFields(formEl) {
  if (!formEl) return [];
  return Array.from(formEl.querySelectorAll('[required]')).filter((el) => !isHoneypotField(el));
}

function isFormValid(formEl) {
  return getRequiredFields(formEl).every((el) => {
    if (el.tagName === 'SELECT') {
      return Boolean(el.value);
    }
    return Boolean((el.value || '').trim());
  });
}

function showMessage(key, isError = false, overrideText) {
  if (!formMessage) return;
  if (overrideText) {
    formMessage.dataset.messageKey = 'custom';
    formMessage.textContent = overrideText;
  } else {
    formMessage.dataset.messageKey = key;
    formMessage.textContent = translate(key);
  }
  formMessage.classList.toggle('error', Boolean(isError));
  formMessage.classList.add('visible');
}

form?.addEventListener('submit', async (event) => {
  event.preventDefault();
  if (isSubmitting) return;

  const honeypotField =
    form.querySelector('#hp_field') ||
    form.querySelector('[name="hp_field"]') ||
    form.querySelector('#website') ||
    form.querySelector('[name="website"]');

  if (honeypotField && honeypotField.value.trim()) {
    return;
  }

  if (!isFormValid(form)) {
    showMessage('contact.form.errorRequired', true);
    return;
  }

  const formData = new FormData(form);
  const name = formData.get('name')?.trim() || '';
  const email = formData.get('email')?.trim() || '';
  const topicValue = formData.get('topic');
  const topic = typeof topicValue === 'string' ? topicValue.trim() : '';
  const message = formData.get('message')?.trim() || '';
  const websiteValue =
    (formData.get('hp_field') || formData.get('website') || '').trim();

  if (!emailPattern.test(email)) {
    showMessage('contact.form.errorEmail', true);
    return;
  }

  setSubmitting(true);

  try {
    const response = await fetch('/api/contact', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Accept: 'application/json'
      },
      body: JSON.stringify({ name, email, topic, message, website: websiteValue })
    });

    let result = null;
    try {
      result = await response.json();
    } catch (err) {
      result = null;
    }

    if (response.ok && result?.ok) {
      form.reset();
      showMessage('contact.form.success', false);
    } else {
      const serverMessage = typeof result?.error === 'string' ? result.error : null;
      showMessage('contact.form.errorServer', true, serverMessage);
    }
  } catch (err) {
    showMessage('contact.form.errorServer', true);
  } finally {
    setSubmitting(false);
  }
});

emailLink?.addEventListener('click', (event) => {
  event.preventDefault();
  if (!form) return;
  const formData = new FormData(form);
  const subjectBase = translate('contact.emailSubject');
  const name = formData.get('name')?.trim();
  const email = formData.get('email')?.trim();
  const topicValue = formData.get('topic');
  const topicOption = form.querySelector(`#topic option[value="${topicValue}"]`);
  const topicText = topicOption ? topicOption.textContent.trim() : '';
  const message = formData.get('message')?.trim();
  const subject = name ? `${subjectBase} – ${name}` : subjectBase;
  const intro = translate('contact.emailBodyIntro');
  const body = `${intro}\n\nName: ${name || ''}\nE-Mail: ${email || ''}\nThema: ${topicText}\nNachricht: ${message || ''}`;
  const mailto = `mailto:info@klarweg.online?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailto;
});

function setCurrentYear() {
  const yearEl = document.getElementById('current-year');
  if (yearEl) {
    yearEl.textContent = new Date().getFullYear();
  }
}

function initLanguage() {
  let saved = 'de';
  try {
    const stored = localStorage.getItem(storageKey);
    if (stored && i18n[stored]) {
      saved = stored;
    }
  } catch (err) {
    saved = 'de';
  }
  applyLanguage(saved);
}

setCurrentYear();
initLanguage();
